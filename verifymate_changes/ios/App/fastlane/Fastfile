# Fastlane configuration for JournalMate iOS
# This file automates building, signing, and deploying to TestFlight/App Store

default_platform(:ios)

platform :ios do
  # Before all lanes
  before_all do
    # Ensure we're on the latest version of Fastlane
    # update_fastlane
  end

  # ==================== BETA LANE (TestFlight) ====================
  desc "Deploy a new Beta Build to TestFlight"
  lane :beta do
    # Ensure clean git status
    ensure_git_status_clean

    # Increment build number (use timestamp or build number)
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: "App.xcodeproj"
    )

    # Setup code signing (using match for team management)
    # Uncomment if using match:
    # match(type: "appstore", readonly: true)
    
    # Build the app
    build_app(
      workspace: "App.xcworkspace",
      scheme: "App",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.journalmate.app" => "match AppStore com.journalmate.app"
        }
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false, # Set to true to distribute to external testers
      notify_external_testers: false,
      changelog: "Bug fixes and improvements"
    )

    # Commit version bump
    commit_version_bump(
      message: "Version bump to #{get_version_number} (#{get_build_number})",
      xcodeproj: "App.xcodeproj"
    )

    # Add git tag
    add_git_tag(
      tag: "ios-v#{get_version_number}-#{get_build_number}"
    )

    # Push to remote
    push_to_git_remote
  end

  # ==================== RELEASE LANE (App Store) ====================
  desc "Deploy a new version to the App Store"
  lane :release do
    # Ensure clean git status
    ensure_git_status_clean

    # Increment version number (optional, or do this manually)
    # increment_version_number(bump_type: "patch")

    # Increment build number
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: "App.xcodeproj"
    )

    # Build the app
    build_app(
      workspace: "App.xcworkspace",
      scheme: "App",
      export_method: "app-store"
    )

    # Upload to App Store
    upload_to_app_store(
      force: true,
      submit_for_review: false, # Set to true to auto-submit
      automatic_release: false,
      skip_metadata: false,
      skip_screenshots: false,
      precheck_include_in_app_purchases: false
    )

    # Commit version bump
    commit_version_bump(
      message: "Release version #{get_version_number}",
      xcodeproj: "App.xcodeproj"
    )

    # Add git tag
    add_git_tag(
      tag: "ios-release-v#{get_version_number}"
    )

    # Push to remote
    push_to_git_remote
  end

  # ==================== SCREENSHOT LANE ====================
  desc "Generate screenshots for all device types"
  lane :screenshots do
    capture_screenshots(
      workspace: "App.xcworkspace",
      scheme: "App"
    )
    upload_to_app_store(skip_binary_upload: true, skip_metadata: true)
  end

  # ==================== HELPER LANES ====================
  desc "Sync code signing certificates"
  lane :sync_certificates do
    match(type: "development", readonly: false)
    match(type: "appstore", readonly: false)
  end

  # ==================== ERROR HANDLING ====================
  error do |lane, exception|
    # This block is called if there was an error
    slack(
      message: exception.message,
      success: false
    ) if ENV['SLACK_URL']
  end
end
